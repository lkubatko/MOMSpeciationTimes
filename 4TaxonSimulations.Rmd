---
title: "Branch Length Simulation Study"
author: "Laura Kubatko, Alexander Leonard, and Julia Chifman"
date: "8/11/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document contains code to reproduce the simulations in the manuscript "Identifiability of speciation times under the multispecies coalescent" by Laura Kubatko, Alexander Leonard, and Julia Chifman for the 4-taxon species trees.<br><br>

We set the initial seed here, so that the results presented in the manuscript can be reproduced exactly. If you would like to repeat the simulation study with a different set of randomly generated data, you need only change the seed in the chunk below.

```{r}
set.seed(65023)
```

#### Part I: Symmetric species tree ####

We include here the following functions:
<ul>
<li> <b>GetTrueProbsSymm</b> -- computes the 9 true site pattern probabilities
<li> <b>SimData</b> -- simulates site patterns from a multinomial distribution using the probabilities computed by GetTrueProbsSymm
<li> <b>GetVarTheory</b> -- computes the theoretical values of the parameters and variances, using the true probabities
<li> <b>GetEstimates</b> -- computes parameters and estimates from the data generated by SimData
</ul>
If you want this code to appear in the output, set echo to TRUE in the relevant chunk. 

```{r, echo=FALSE}
GetTrueProbsSymm = function(myt1,myt2,myt3,theta,alpha) {

  #these get us the site pattern frequencies that match the data sets generated by the seq-gen
  #pipeline that is commonly used in simulation studies
  #the order of the site patterns is as in the headings in Table 1 in the Supplement to Chifman and Kubatko (2015):
  # xxxx - 1
  # xxxy = xxyx - 2
  # xyxx = yxxx - 3
  # xyxy = yxxy - 4
  # xxyy - 5
  # xxyz - 6
  # yzxx - 7
  # xyzx = yxxz = xyzx = yxzx - 8
  # xyzw - 9

  t1 = myt1*theta  # t1*theta
  t2 = myt2*theta  # t2*theta
  t3 = myt3*theta  # t3*theta
  t = 2*theta      # 2*theta
  m = alpha        # mu for JC69

  #compute the C matrix
  cmat = matrix(0,ncol=9,nrow=9)
  # row 1
  for (i in 1:9) cmat[1,i] = 1/256
  # row 2
  cmat[2,1]=cmat[2,3]=cmat[2,5]=cmat[2,7] = 3/(256*(1+m*t))
  cmat[2,2]=cmat[2,4]=cmat[2,6]=cmat[2,8]=cmat[2,9]=-1/(256*(1+m*t))
  # row 3
  cmat[3,1]=cmat[3,2]=cmat[3,5]=cmat[3,6]=3/(256*(1+m*t))
  cmat[3,3]=cmat[3,4]=cmat[3,7]=cmat[3,8]=cmat[3,9]=-1/(256*(1+m*t))
  # row 4
  cmat[4,1]=cmat[4,5] = 9/(256*(1+m*t)^2)
  cmat[4,2]=cmat[4,3]=cmat[4,6]=cmat[4,7] = -3/(256*(1+m*t)^2)
  cmat[4,4]=cmat[4,8]=cmat[4,9] = 1/(256*(1+m*t)^2)
  # row 5
  cmat[5,1]=12/(256*(1+m*t))
  cmat[5,2]=cmat[5,3]=cmat[5,4]=4/(256*(1+m*t))
  cmat[5,5]=cmat[5,6]=cmat[5,7]=cmat[5,9]=-4/(256*(1+m*t))
  cmat[5,8]=0
  # row 6
  cmat[6,1]=24/(256*(1+m*t)*(2+m*t))
  cmat[6,2]=cmat[6,4]=cmat[6,5]=cmat[6,7]=-8/(256*(1+m*t)*(2+m*t))
  cmat[6,3]=8/(256*(1+m*t)*(2+m*t))
  cmat[6,6]=cmat[6,9]=8/(256*(1+m*t)*(2+m*t))
  cmat[6,8]=0
  # row 7
  cmat[7,1]=24/(256*(1+m*t)*(2+m*t))
  cmat[7,2]=8/(256*(1+m*t)*(2+m*t))
  cmat[7,3]=cmat[7,4]=cmat[7,5]=cmat[7,6]=-8/(256*(1+m*t)*(2+m*t))
  cmat[7,7]=cmat[7,9]=8/(256*(1+m*t)*(2+m*t))
  cmat[7,8]=0
  # row 8
  cmat[8,1]=48/(256*(1+m*t)*(2+m*t)^2)
  cmat[8,2]=cmat[8,3]=cmat[8,5]=-16/(256*(1+m*t)*(2+m*t)^2)
  cmat[8,4]=cmat[8,6]=cmat[8,7]=16/(256*(1+m*t)*(2+m*t)^2)
  cmat[8,8]=0
  cmat[8,9]=-16/(256*(1+m*t)*(2+m*t)^2)
  # row 9
  cmat[9,1]=6*m*t*(4+m*t)*(4+3*m*t)/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))
  cmat[9,2]=cmat[9,3]=-2*m*t*(4+m*t)*(4+3*m*t)/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))
  cmat[9,4]=m*t*(32+40*m*t+10*(m^2)*(t^2))/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))
  cmat[9,5]=2*m*t*(4+m*t)^2/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))
  cmat[9,6]=cmat[9,7]=2*(m^2)*(t^2)*(4+m*t)/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))
  cmat[9,8]=-(m^2)*(t^2)*(4+2*m*t)/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))
  cmat[9,9]=2*(m^3)*(t^3)/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t))

  #get the beta vector
  beta = matrix(0,ncol=1,nrow=9)
  beta[1,1]=1
  beta[2,1]=exp(-2*m*t1)
  beta[3,1]=exp(-2*m*t2)
  beta[4,1]=exp(-2*m*t1)*exp(-2*m*t2)
  beta[5,1]=exp(-2*m*t3)
  beta[6,1]=exp(-m*t1)*exp(-2*m*t3)
  beta[7,1]=exp(-m*t2)*exp(-2*m*t3)
  beta[8,1]=exp(-m*t1)*exp(-m*t2)*exp(-2*m*t3)
  beta[9,1]=exp(2*t1/t)*exp(2*t2/t)*exp(-4*t3*(m+1/t))	#### DLS to LK: shouldn't the first two -2 be +2 ? Yes, fixed.

  weights=matrix(0,ncol=9,nrow=1)
  w1=weights[1,1]=4
  w2=weights[1,2]=24
  w3=weights[1,3]=24
  w4=weights[1,4]=24
  w5=weights[1,5]=12
  w6=weights[1,6]=24
  w7=weights[1,7]=24
  w8=weights[1,8]=24*4
  w9=weights[1,9]=24

  p=t(cmat)%*%beta
  # check that we have counted all site pattern probabilities
  #sum(weights)
  # check that we have a valid probability distribution
  #print(weights%*%p)

  return(p)
}

SimData = function(myt1,myt2,myt3,theta,mu,samplesize) {

	w1=4
	w2=24
	w3=24
	w4=24
	w5=12
	w6=24
	w7=24
	w8=96
	w9=24
  	myprobs = GetTrueProbsSymm(myt1,myt2,myt3,theta,mu)
simdata = rmultinom(1,samplesize,c(w1*myprobs[1],w2*myprobs[2],w3*myprobs[3],w4*myprobs[4],w5*myprobs[5],w6*myprobs[6],w7*myprobs[7],w8*myprobs[8],w9*myprobs[9]))

	return(simdata)

}

GetVarTheory = function(probs,mytheta,mymu,nn) {
	
  mu = mytheta*mymu
  theta = 2.0
  
	p1 = 4*probs[1]
	p2 = 24*probs[2]
	p3 = 24*probs[3]
	p4 = 24*probs[4]
	p5 = 12*probs[5]
	p6 = 24*probs[6]
	p7 = 24*probs[7]
	p8 = 96*probs[8]
	p9 = 24*probs[9]
	
	pp1 = probs[1]
	pp2 = probs[2]
	pp3 = probs[3]
	pp4 = probs[4]
	pp5 = probs[5]
	pp6 = probs[6]
	pp7 = probs[7]
	pp8 = probs[8]
	pp9 = probs[9]
	
	x12 = 4*(1+mu*theta)*(pp1-2*pp2+3*pp5-2*pp6+6*pp3-2*pp4-8*pp8-2*pp9+6*pp7)
	x22 = 4*(1+mu*theta)*(pp1+6*pp2+3*pp5+6*pp6-2*pp3-2*pp4-8*pp8-2*pp9-2*pp7)
	x32 = 4*(1+mu*theta)*(pp1+2*pp2-pp5-2*pp6+2*pp3+2*pp4-2*pp9-2*pp7)

	tau1 = -log(x12^(1/(2*mu)))
	tau2 = -log(x22^(1/(2*mu)))
	tau3 = -log(x32^(1/(2*mu))) 

	w1=4
	w2=24
	w3=24
	w4=24
	w5=12
	w6=24
	w7=24
	w8=24*4
	w9=24

	var1 = p1*(1-p1)/(nn*w1^2)
	var2 = p2*(1-p2)/(nn*w2^2)
	var3 = p3*(1-p3)/(nn*w3^2)
	var4 = p4*(1-p4)/(nn*w4^2)
	var5 = p5*(1-p5)/(nn*w5^2)
	var6 = p6*(1-p6)/(nn*w6^2)
	var7 = p7*(1-p7)/(nn*w7^2)
	var8 = p8*(1-p8)/(nn*w8^2)
	var9 = p9*(1-p9)/(nn*w9^2)
    
	covar12 = -p1*p2/(nn*w1*w2)
	covar13 = -p1*p3/(nn*w1*w3)
	covar14 = -p1*p4/(nn*w1*w4)
	covar15 = -p1*p5/(nn*w1*w5)
	covar16 = -p1*p6/(nn*w1*w6)
	covar17 = -p1*p7/(nn*w1*w7)
	covar18 = -p1*p8/(nn*w1*w8)
	covar19 = -p1*p9/(nn*w1*w9)
    
	covar23 = -p2*p3/(nn*w2*w3)
	covar24 = -p2*p4/(nn*w2*w4)
	covar25 = -p2*p5/(nn*w2*w5)
	covar26 = -p2*p6/(nn*w2*w6)
	covar27 = -p2*p7/(nn*w2*w7)
	covar28 = -p2*p8/(nn*w2*w8)
	covar29 = -p2*p9/(nn*w2*w9)
    
	covar34 = -p3*p4/(nn*w3*w4)
	covar35 = -p3*p5/(nn*w3*w5)
	covar36 = -p3*p6/(nn*w3*w6)
	covar37 = -p3*p7/(nn*w3*w7)
	covar38 = -p3*p8/(nn*w3*w8)
	covar39 = -p3*p9/(nn*w3*w9)
    
	covar45 = -p4*p5/(nn*w4*w5)
	covar46 = -p4*p6/(nn*w4*w6)
	covar47 = -p4*p7/(nn*w4*w7)
	covar48 = -p4*p8/(nn*w4*w8)
	covar49 = -p4*p9/(nn*w4*w9)
    
	covar56 = -p5*p6/(nn*w5*w6)
	covar57 = -p5*p7/(nn*w5*w7)
	covar58 = -p5*p8/(nn*w5*w8)
	covar59 = -p5*p9/(nn*w5*w9)
    
	covar67 = -p6*p7/(nn*w6*w7)
	covar68 = -p6*p8/(nn*w6*w8)
	covar69 = -p6*p9/(nn*w6*w9)
    
	covar78 = -p7*p8/(nn*w7*w8)
	covar79 = -p7*p9/(nn*w7*w9)
    
	covar89 = -p8*p9/(nn*w8*w9)


	var_myx1 = 16*((1+mu*theta)^2)*(var1+4*var2+9*var5+4*var6+36*var3+4*var4+64*var8+4*var9+36*var7
	                                -4*covar12+6*covar15-4*covar16+12*covar13-4*covar14-16*covar18-4*covar19+12*covar17
	                                         -12*covar25+8*covar26-24*covar23+8*covar24+32*covar28+8*covar29-24*covar27
	                                                   -12*covar56+36*covar35-12*covar45-48*covar58-12*covar59+36*covar57
	                                                              -24*covar36+8*covar46+32*covar68+8*covar69-24*covar67
	                                                                        -24*covar34-96*covar38-24*covar39+72*covar37
	                                                                                   +32*covar48+8*covar49-24*covar47
	                                                                                             +32*covar89-96*covar78
	                                                                                                        -24*covar79)
    
	var_myx2 = 16*((1+mu*theta)^2)*(var1+36*var2+9*var5+36*var6+4*var3+4*var4+64*var8+4*var9+4*var7+12*covar12+6*covar15+12*covar16-4*covar13-4*covar14-16*covar18-4*covar19-4*covar17+36*covar25+72*covar26-24*covar23+8*covar24+32*covar28+8*covar29-24*covar27+36*covar56-12*covar35-12*covar45-48*covar58-12*covar59-12*covar57-24*covar36+8*covar46+32*covar68+8*covar69-24*covar67-24*covar34-96*covar38-24*covar39+8*covar37+32*covar48+8*covar49+8*covar47+32*covar89+32*covar78+8*covar79)
    
	var_myx3 = 16*((1+mu*theta)^2)*(var1+4*var2+var5+4*var6+4*var3+4*var4+4*var9+4*var7+4*covar12-2*covar15-4*covar16+4*covar13+4*covar14-4*covar19-4*covar17-4*covar25-8*covar26+8*covar23+8*covar24-8*covar29-8*covar27+4*covar56-4*covar35-4*covar45+4*covar59+4*covar57-8*covar36-8*covar46+8*covar69+8*covar67+8*covar34-8*covar39-8*covar37-8*covar49-8*covar47+8*covar79)
	
	return(c(x12,x22,x32,tau1,tau2,tau3,var_myx1,var_myx2,var_myx3))
	
}

GetEstimates = function(data1,mytheta,mymu,nn) {
  
  mu = mytheta*mymu
  theta = 2.0
  
  p1 = data1[1]/nn
  p2 = data1[2]/nn
  p3 = data1[3]/nn
  p4 = data1[4]/nn
  p5 = data1[5]/nn
  p6 = data1[6]/nn
  p7 = data1[7]/nn
  p8 = data1[8]/nn
  p9 = data1[9]/nn
  
  pp1 = p1/4 
  pp3 = p3/(2*12)
  pp2 = p2/(2*12)
  pp4 = p4/(2*12)
  pp5 = p5/12
  pp7 = p7/24
  pp6 = p6/24
  pp8 = p8/(4*24)
  pp9 = p9/24
  
  x12 = 4*(1+mu*theta)*(pp1-2*pp2+3*pp5-2*pp6+6*pp3-2*pp4-8*pp8-2*pp9+6*pp7)
  x22 = 4*(1+mu*theta)*(pp1+6*pp2+3*pp5+6*pp6-2*pp3-2*pp4-8*pp8-2*pp9-2*pp7)
  x32 = 4*(1+mu*theta)*(pp1+2*pp2-pp5-2*pp6+2*pp3+2*pp4-2*pp9-2*pp7)

  tau1 = -log(x12^(1/(2*mu)))
  tau2 = -log(x22^(1/(2*mu)))
  tau3 = -log(x32^(1/(2*mu))) 
  
  w1=4
  w2=24
  w3=24
  w4=24
  w5=12
  w6=24
  w7=24
  w8=96
  w9=24

  var1 = p1*(1-p1)/(nn*w1^2)
  var2 = p2*(1-p2)/(nn*w2^2)
  var3 = p3*(1-p3)/(nn*w3^2)
  var4 = p4*(1-p4)/(nn*w4^2)
  var5 = p5*(1-p5)/(nn*w5^2)
  var6 = p6*(1-p6)/(nn*w6^2)
  var7 = p7*(1-p7)/(nn*w7^2)
  var8 = p8*(1-p8)/(nn*w8^2)
  var9 = p9*(1-p9)/(nn*w9^2)
    
  covar12 = -p1*p2/(nn*w1*w2)
  covar13 = -p1*p3/(nn*w1*w3)
  covar14 = -p1*p4/(nn*w1*w4)
  covar15 = -p1*p5/(nn*w1*w5)
  covar16 = -p1*p6/(nn*w1*w6)
  covar17 = -p1*p7/(nn*w1*w7)
  covar18 = -p1*p8/(nn*w1*w8)
  covar19 = -p1*p9/(nn*w1*w9)
    
  covar23 = -p2*p3/(nn*w2*w3)
  covar24 = -p2*p4/(nn*w2*w4)
  covar25 = -p2*p5/(nn*w2*w5)
  covar26 = -p2*p6/(nn*w2*w6)
  covar27 = -p2*p7/(nn*w2*w7)
  covar28 = -p2*p8/(nn*w2*w8)
  covar29 = -p2*p9/(nn*w2*w9)
    
  covar34 = -p3*p4/(nn*w3*w4)
  covar35 = -p3*p5/(nn*w3*w5)
  covar36 = -p3*p6/(nn*w3*w6)
  covar37 = -p3*p7/(nn*w3*w7)
  covar38 = -p3*p8/(nn*w3*w8)
  covar39 = -p3*p9/(nn*w3*w9)
    
  covar45 = -p4*p5/(nn*w4*w5)
  covar46 = -p4*p6/(nn*w4*w6)
  covar47 = -p4*p7/(nn*w4*w7)
  covar48 = -p4*p8/(nn*w4*w8)
  covar49 = -p4*p9/(nn*w4*w9)
    
  covar56 = -p5*p6/(nn*w5*w6)
  covar57 = -p5*p7/(nn*w5*w7)
  covar58 = -p5*p8/(nn*w5*w8)
  covar59 = -p5*p9/(nn*w5*w9)
    
  covar67 = -p6*p7/(nn*w6*w7)
  covar68 = -p6*p8/(nn*w6*w8)
  covar69 = -p6*p9/(nn*w6*w9)
    
  covar78 = -p7*p8/(nn*w7*w8)
  covar79 = -p7*p9/(nn*w7*w9)
    
  covar89 = -p8*p9/(nn*w8*w9)

  var_myx1 = var_myx1 = 16*((1+mu*theta)^2)*(var1+4*var2+9*var5+4*var6+36*var3+4*var4+64*var8+4*var9+36*var7
	                                -4*covar12+6*covar15-4*covar16+12*covar13-4*covar14-16*covar18-4*covar19+12*covar17
	                                         -12*covar25+8*covar26-24*covar23+8*covar24+32*covar28+8*covar29-24*covar27
	                                                   -12*covar56+36*covar35-12*covar45-48*covar58-12*covar59+36*covar57
	                                                              -24*covar36+8*covar46+32*covar68+8*covar69-24*covar67
	                                                                        -24*covar34-96*covar38-24*covar39+72*covar37
	                                                                                   +32*covar48+8*covar49-24*covar47
	                                                                                             +32*covar89-96*covar78
	                                                                                                        -24*covar79)
    
  var_myx2 = 16*((1+mu*theta)^2)*(var1+36*var2+9*var5+36*var6+4*var3+4*var4+64*var8+4*var9+4*var7+12*covar12+6*covar15+12*covar16-4*covar13-4*covar14-16*covar18-4*covar19-4*covar17+36*covar25+72*covar26-24*covar23+8*covar24+32*covar28+8*covar29-24*covar27+36*covar56-12*covar35-12*covar45-48*covar58-12*covar59-12*covar57-24*covar36+8*covar46+32*covar68+8*covar69-24*covar67-24*covar34-96*covar38-24*covar39+8*covar37+32*covar48+8*covar49+8*covar47+32*covar89+32*covar78+8*covar79)
    
  var_myx3 = 16*((1+mu*theta)^2)*(var1+4*var2+var5+4*var6+4*var3+4*var4+4*var9+4*var7+4*covar12-2*covar15-4*covar16+4*covar13+4*covar14-4*covar19-4*covar17-4*covar25-8*covar26+8*covar23+8*covar24-8*covar29-8*covar27+4*covar56-4*covar35-4*covar45+4*covar59+4*covar57-8*covar36-8*covar46+8*covar69+8*covar67+8*covar34-8*covar39-8*covar37-8*covar49-8*covar47+8*covar79)

 return(c(x12,x22,x32,tau1,tau2,tau3,var_myx1,var_myx2,var_myx3))
  
}


```

To get started, we demonstrate how the functions work. We can compute the true site pattern probabilities for a tree with $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, and $\theta = 0.01$ as follows (note that $\alpha = 4/3$ as specified by the JC69 model):

```{r}
trueq = GetTrueProbsSymm(myt1=1.0,myt2=1.5,myt3=2.5,theta=0.01,alpha=4.0/3.0)
print(trueq)
```


Next, we can generate $n=100,000$ coalescent independent sites (CIS) from this model:

```{r}
q = SimData(myt1=1.0,myt2=1.5,myt3=2.5,theta=0.01,mu=4.0/3.0,samplesize=100000)
print(q)
```


We can compute the true values of the variances of the x's for a sample of 100,000 CIS. These are the theoretical values predicted by our  model.

```{r}
truevals = GetVarTheory(probs=trueq,mytheta=0.01,mymu=4.0/3.0,n=100000)
print(c(truevals[4],truevals[5],truevals[6]))
print(c(truevals[7],truevals[8],truevals[9]))
```

Finally, we estimate the parameters and variances for the sample data we generated above:

```{r}
ests = GetEstimates(q,0.01,4.0/3.0,100000)
# Estimates of branch lengths:
print(c(ests[4],ests[5],ests[6]))
# Estimates of variances of x's:
print(c(ests[7],ests[8],ests[9]))
```

Now we're ready for the simulation studies.

### Simulation Study 1 ###

We repeat the procedure B times and plot the parameter estimates, comparing with their true values. We also plot the first 100 of the 95% confidence intervals and look at their empirical coverage. In the plots below, the black line is the true theoretical value, and the gray line is the empirical value computed from all of the simulation replicates.

```{r, fig.width=10, fig.height=4, echo=FALSE}

MakeSummaries = function(results,truevals,theta,mu,nnreps) {

  par(mfrow=c(1,3),mai=c(1,1,0.25,0.25))
  hist(results[,1],nclass=10,xlab=expression(paste(x[1])),main=expression(paste("Estimated values of ",x[1])),cex.lab=1.7,cex.axis=1.4,col="lightskyblue")
  lines(c(mean(results[,1]),mean(results[,1])),c(0,nnreps),lwd=6,col="gray")
  lines(c(truevals[1],truevals[1]),c(0,nnreps),lwd=3)
  hist(results[,2],nclass=10,xlab=expression(paste(x[2])),main=expression(paste("Estimated values of ",x[2])),cex.lab=1.7,cex.axis=1.4,col="lightskyblue")
  lines(c(mean(results[,2]),mean(results[,2])),c(0,nnreps),lwd=6,col="gray")
  lines(c(truevals[2],truevals[2]),c(0,nnreps),lwd=3)
  hist(results[,3],nclass=10,xlab=expression(paste(x[3])),main=expression(paste("Estimated values of ",x[3])),cex.lab=1.7,cex.axis=1.4,col="lightskyblue")
  lines(c(mean(results[,3]),mean(results[,3])),c(0,nnreps),lwd=6,col="gray")
  lines(c(truevals[3],truevals[3]),c(0,nnreps),lwd=3)


  hist(results[,7],nclass=10,xlab=expression(paste("Var(",x[1],")")),main=expression(paste("Estimated variances of ",x[1])),cex.lab=1.7,cex.axis=1.4,col="lightskyblue")
  lines(c(var(results[,1]),var(results[,1])),c(0,nnreps),lwd=6,col="gray")
  lines(c(truevals[7],truevals[7]),c(0,nnreps),lwd=3)
  hist(results[,8],nclass=10,xlab=expression(paste("Var(",x[2],")")),main=expression(paste("Estimated variances of ",x[2])),cex.lab=1.7,cex.axis=1.4,col="lightskyblue")
  lines(c(var(results[,2]),var(results[,2])),c(0,nnreps),lwd=6,col="gray")
  lines(c(truevals[8],truevals[8]),c(0,nnreps),lwd=3)
  hist(results[,9],nclass=10,xlab=expression(paste("Var(",x[3],")")),main=expression(paste("Estimated variances of ",x[3])),cex.lab=1.7,cex.axis=1.4,col="lightskyblue")
  lines(c(var(results[,3]),var(results[,3])),c(0,nnreps),lwd=6,col="gray")
  lines(c(truevals[9],truevals[9]),c(0,nnreps),lwd=3)

  plot(seq(1,nnreps,1),results[,7],pch=20,xlab="Simulation Replicate",ylab="Variance",main=expression(paste("Estimated variances of ",x[1])),cex.lab=1.7,cex.axis=1.4)
  lines(c(0,nnreps),c(var(results[,1]),var(results[,1])),lwd=6,col="gray")
  lines(c(0,nnreps),c(truevals[7],truevals[7]),lwd=3,col="red")

  plot(seq(1,nnreps,1),results[,8],pch=20,xlab="Simulation Replicate",ylab="Variance",main=expression(paste("Estimated variances of ",x[2])),cex.lab=1.7,cex.axis=1.)
  lines(c(0,nnreps),c(var(results[,2]),var(results[,2])),lwd=6,col="gray")
  lines(c(0,nnreps),c(truevals[8],truevals[8]),lwd=3,col="red")

  plot(seq(1,nnreps,1),results[,9],pch=20,xlab="Simulation Replicate",ylab="Variance",main=expression(paste("Estimated variances of ",x[3])),cex.lab=1.7,cex.axis=1.)
  lines(c(0,nnreps),c(var(results[,3]),var(results[,3])),lwd=6,col="gray")
  lines(c(0,nnreps),c(truevals[9],truevals[9]),lwd=3,col="red")

  # Look at coverage of CIs

  # tau1
  ll = results[,1]-1.96*sqrt(results[,7])
  ul = results[,1]+1.96*sqrt(results[,7])
  lltau1 = -log(ul^(1/(2*theta*mu)))
  ultau1 = -log(ll^(1/(2*theta*mu)))

  # tau2
  ll = results[,2]-1.96*sqrt(results[,8])
  ul = results[,2]+1.96*sqrt(results[,8])
  lltau2 = -log(ul^(1/(2*theta*mu)))
  ultau2 = -log(ll^(1/(2*theta*mu)))

  # tau3
  ll = results[,3]-1.96*sqrt(results[,9])
  ul = results[,3]+1.96*sqrt(results[,9])
  lltau3 = -log(ul^(1/(2*theta*mu)))
  ultau3 = -log(ll^(1/(2*theta*mu)))

  # only plot the first 100 CIs
  plot(c(min(lltau1),max(ultau1)),c(0,101),type='n',xlab=expression(paste(tau[1])),cex.lab=2.0,ylab="",main="Confidence Intervals for tau1")
  for (i in 1:100) lines(c(lltau1[i],ultau1[i]),c(i,i))
  lines(c(truevals[4],truevals[4]),c(0,101),col="maroon")

  plot(c(min(lltau2),max(ultau2)),c(0,101),type='n',xlab=expression(paste(tau[2])),cex.lab=2.0,ylab="",main="Confidence Intervals for tau2")
  for (i in 1:100) lines(c(lltau2[i],ultau2[i]),c(i,i))
  lines(c(truevals[5],truevals[5]),c(0,101),col="maroon")

  plot(c(min(lltau3),max(ultau3)),c(0,101),type='n',xlab=expression(paste(tau[3])),cex.lab=2.0,ylab="",main="Confidence Intervals for tau3")
  for (i in 1:100) lines(c(lltau3[i],ultau3[i]),c(i,i))
  lines(c(truevals[6],truevals[6]),c(0,101),col="maroon")

  # percent intervals containing the true value for tau1
  llcheck=matrix(lltau1<truevals[4],ncol=1)
  ulcheck=matrix(ultau1>truevals[4],ncol=1)
  print("Proportion of 95% CIs including tau1:")
  print(sum(ulcheck+llcheck==2)/nnreps)

  # percent intervals containing the true value for tau2
  llcheck=matrix(lltau2<truevals[5],ncol=1)
  ulcheck=matrix(ultau2>truevals[5],ncol=1)
  print("Proportion of 95% CIs including tau2:")
  print(sum(ulcheck+llcheck==2)/nnreps)

  # percent intervals containing the true value for tau3
  llcheck=matrix(lltau3<truevals[6],ncol=1)
  ulcheck=matrix(ultau3>truevals[6],ncol=1)
  print("Proportion of 95% CIs including tau3:")
  print(sum(ulcheck+llcheck==2)/nnreps)

}

```


```{r, fig.width=10, fig.height=4, echo=FALSE}

RunSim = function(settau1,settau2,settau3,settheta,setmu,setsamsize,nsimreps) {

  myn = nsimreps-1
  q = SimData(myt1=settau1,myt2=settau2,myt3=settau3,theta=settheta,mu=setmu,samplesize=setsamsize)
  results = GetEstimates(q,settheta,setmu,setsamsize)

  for (i in 1:myn) {

    q = SimData(myt1=settau1,myt2=settau2,myt3=settau3,theta=settheta,mu=setmu,samplesize=setsamsize)
    ests = GetEstimates(q,settheta,setmu,setsamsize)
    results=rbind(results,ests)

  }

  return(results)

}
```



<br><br>
Setting 1: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.001$, $n=100,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 1:

nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.001
smu=4.0/3.0

results1 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq1 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals1 = GetVarTheory(probs=trueq1,stheta,smu,nsites)
MakeSummaries(results1,truevals1,stheta,smu,nreps)
```

<br><br>
Setting 2: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.005$, $n=100,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 2:
nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.005
smu=4.0/3.0

results2 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq2 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals2 = GetVarTheory(probs=trueq2,stheta,smu,nsites)
MakeSummaries(results2,truevals2,stheta,smu,nreps)
```

<br><br>
Setting 3: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.001$, $n=100,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 3:
nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.001
smu=4.0/3.0

results3 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq3 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals3 = GetVarTheory(probs=trueq3,stheta,smu,nsites)
MakeSummaries(results3,truevals3,stheta,smu,nreps)
```


<br><br>
Setting 4: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.005$, $n=100,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 4:
nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.005
smu=4.0/3.0

results4 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq4 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals4 = GetVarTheory(probs=trueq4,stheta,smu,nsites)
MakeSummaries(results4,truevals4,stheta,smu,nreps)
```



<br><br>
Setting 5: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.001$, $n=10,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 5:
nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.001
smu=4.0/3.0

results5 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq5 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals5 = GetVarTheory(probs=trueq5,stheta,smu,nsites)
MakeSummaries(results5,truevals5,stheta,smu,nreps)
```

<br><br>
Setting 6: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.005$, $n=10,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 6:
nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.005
smu=4.0/3.0

results6 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq6 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals6 = GetVarTheory(probs=trueq6,stheta,smu,nsites)
MakeSummaries(results6,truevals6,stheta,smu,nreps)
```


<br><br>
Setting 7: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.001$, $n=10,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 7:
nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.001
smu=4.0/3.0

results7 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq7 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals7 = GetVarTheory(probs=trueq7,stheta,smu,nsites)
MakeSummaries(results7,truevals7,stheta,smu,nreps)
```


<br><br>
Setting 8: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.005$, $n=10,000$

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 8:
nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.005
smu=4.0/3.0

results8 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq8 = GetTrueProbsSymm(stau1,stau2,stau3,stheta,smu)
truevals8 = GetVarTheory(probs=trueq8,stheta,smu,nsites)
MakeSummaries(results8,truevals8,stheta,smu,nreps)
```

<br><br><br>

#### Part II: Asymmetric species tree ####

We include the same four functions as for the symmetric case:
<ul>
<li> <b>GetTrueProbsAsymm</b> -- computes the 11 true site pattern probabilities
<li> <b>SimDataAsymm</b> -- simulates site patterns from a multinomial distribution using the probabilities computed by GetTrueProbsAsymm
<li> <b>GetVarTheoryAsymm</b> -- computes the theoretical values of the parameters and variances, using the true probabities
<li> <b>GetEstimatesAsymm</b> -- computes parameters and estimates from the data generated by SimDataAsymm
</ul>
If you want this code to appear in the output, set echo to TRUE in the relevant chunk.


```{r, echo=FALSE}
GetTrueProbsAsymm = function(myt1,myt2,myt3,theta,alpha) {

  #these get us the site pattern frequencies that match the data sets generated by the seq-gen
  #pipeline that is commonly used in simulation studies
  #the order of the site patterns is as in the headings in Table 2 in the Supplement to Chifman and Kubatko (2015):
  # xxxx - 1
  # xxxy = xxyx - 2
  # xyxx - 3
  # yxxx - 4
  # xxyy - 5
  # xyxy = yxxy - 6
  # xxyz - 7
  # yzxx - 8
  # xyxz = xyzx - 9
  # yxxz = yxzx - 10
  # xyzw - 11

t1 = myt1*theta  # t1*theta 
t2 = myt2*theta  # t2*theta
t3 = myt3*theta  # t3*theta
t = 2*theta      # 2*theta
m = alpha        # mu for JC69

#compute the C matrix
cmat = matrix(0,ncol=10,nrow=11) 
# row 1 
   cmat[1,1] = 1/256 
   cmat[1,2] = 3/((256)*(1+m*t)) 
   cmat[1,3] = 6/(256*(1+m*t)) 
   cmat[1,4] = 12/(256*(1+m*t)*(2+m*t)) 
   cmat[1,5] = 9/(256*(1+m*t)) 
   cmat[1,6] = 12/(256*(1+m*t)*(2+m*t)) 
   cmat[1,7] = 9/(256*(1+m*t)^2) 
   cmat[1,8] = 24/(256*(1+m*t)*(2+m*t)) 
   cmat[1,9] = 48/(256*(1+m*t)*(2+m*t)^2) 
   cmat[1,10] = (6*m*t*(4+m*t)*(4+3*m*t))/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 2 
   cmat[2,1] = 1/256 
   cmat[2,2] = -1/(256*(1+m*t)) 
   cmat[2,3] = 2/(256*(1+m*t)) 
   cmat[2,4] = -4/(256*(1+m*t)*(2+m*t)) 
   cmat[2,5] = 5/(256*(1+m*t)) 
   cmat[2,6] = -4/(256*(1+m*t)*(2+m*t)) 
   cmat[2,7] = -3/(256*(1+m*t)^2) 
   cmat[2,8] = 8/(256*(1+m*t)*(2+m*t)) 
   cmat[2,9] = -16/(256*(1+m*t)*(2+m*t)^2) 
   cmat[2,10] = -(2*m*t*(4+m*t)*(4+3*m*t))/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 3 
   cmat[3,1] = 1/256 
   cmat[3,2] = 3/(256*(1+m*t)) 
   cmat[3,3] = -2/(256*(1+m*t)) 
   cmat[3,4] = -4/(256*(1+m*t)*(2+m*t)) 
   cmat[3,5] = 5/(256*(1+m*t)) 
   cmat[3,6] = 12/(256*(1+m*t)*(2+m*t)) 
   cmat[3,7] = -3/(256*(1+m*t)^2) 
   cmat[3,8] = -8/(256*(1+m*t)*(2+m*t)) 
   cmat[3,9] = -16/(256*(1+m*t)*(2+m*t)^2) 
   cmat[3,10] = -(2*m*t*(4+m*t)*(4+3*m*t))/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 4 
   cmat[4,1] = 1/256 
   cmat[4,2] = 3/(256*(1+m*t)) 
   cmat[4,3] = 6/(256*(1+m*t)) 
   cmat[4,4] = 12/(256*(1+m*t)*(2+m*t)) 
   cmat[4,5] = -3/(256*(1+m*t)) 
   cmat[4,6] = -4/(256*(1+m*t)*(2+m*t)) 
   cmat[4,7] = -3/(256*(1+m*t)^2) 
   cmat[4,8] = -8/(256*(1+m*t)*(2+m*t)) 
   cmat[4,9] = -16/(256*(1+m*t)*(2+m*t)^2) 
   cmat[4,10] = -(2*m*t*(4+m*t)*(4+3*m*t))/(256*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   #row 5 
   cmat[5,1] = 1/256 
   cmat[5,2] = 3/((256)*(1+m*t)) 
   cmat[5,3] = -2/((256)*(1+m*t)) 
   cmat[5,4] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[5,5] = 1/((256)*(1+m*t)) 
   cmat[5,6] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[5,7] = 9/((256)*(1+m*t)^2) 
   cmat[5,8] = -8/((256)*(1+m*t)*(2+m*t)) 
   cmat[5,9] = -16/((256)*(1+m*t)*(2+m*t)^2) 
   cmat[5,10] = (2*m*t*(4+m*t)^2)/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 6 
   cmat[6,1] = 1/256 
   cmat[6,2] = -1/((256)*(1+m*t)) 
   cmat[6,3] = 2/((256)*(1+m*t)) 
   cmat[6,4] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[6,5] = 1/((256)*(1+m*t)) 
   cmat[6,6] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[6,7] = 1/((256)*(1+m*t)^2) 
   cmat[6,8] = -8/((256)*(1+m*t)*(2+m*t)) 
   cmat[6,9] = 16/((256)*(1+m*t)*(2+m*t)^2) 
   cmat[6,10] = m*t*(2*16+40*m*t+(10)*(m^2)*(t^2))/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 7 
   cmat[7,1] = 1/256 
   cmat[7,2] = -1/((256)*(1+m*t)) 
   cmat[7,3] = -2/((256)*(1+m*t)) 
   cmat[7,4] = 4/((256)*(1+m*t)*(2+m*t)) 
   cmat[7,5] = 1/((256)*(1+m*t)) 
   cmat[7,6] = 4/((256)*(1+m*t)*(2+m*t)) 
   cmat[7,7] = -3/((256)*(1+m*t)^2) 
   cmat[7,8] = -8/((256)*(1+m*t)*(2+m*t)) 
   cmat[7,9] = 16/((256)*(1+m*t)*(2+m*t)^2) 
   cmat[7,10] = 2*(m^2)*(t^2)*(4+m*t)/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 8 
   cmat[8,1] = 1/256 
   cmat[8,2] = 3/((256)*(1+m*t)) 
   cmat[8,3] = -2/((256)*(1+m*t)) 
   cmat[8,4] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[8,5] = -3/((256)*(1+m*t)) 
   cmat[8,6] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[8,7] = -3/((256)*(1+m*t)^2) 
   cmat[8,8] = 8/((256)*(1+m*t)*(2+m*t)) 
   cmat[8,9] = 16/((256)*(1+m*t)*(2+m*t)^2) 
   cmat[8,10] = 2*(m^2)*(t^2)*(4+m*t)/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 9 
   cmat[9,1] = 1/256 
   cmat[9,2] = -1/((256)*(1+m*t)) 
   cmat[9,3] = -2/((256)*(1+m*t)) 
   cmat[9,4] = 4/((256)*(1+m*t)*(2+m*t)) 
   cmat[9,5] = 1/((256)*(1+m*t)) 
   cmat[9,6] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[9,7] = 1/((256)*(1+m*t)^2) 
   cmat[9,8] = 0 
   cmat[9,9] = 0 
   cmat[9,10] = -(m^2)*(t^2)*(4+2*m*t)/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 10 
   cmat[10,1] = 1/256 
   cmat[10,2] = -1/((256)*(1+m*t)) 
   cmat[10,3] = 2/((256)*(1+m*t)) 
   cmat[10,4] = -4/((256)*(1+m*t)*(2+m*t)) 
   cmat[10,5] = -3/((256)*(1+m*t)) 
   cmat[10,6] = 4/((256)*(1+m*t)*(2+m*t)) 
   cmat[10,7] = 1/((256)*(1+m*t)^2) 
   cmat[10,8] = 0 
   cmat[10,9] = 0 
   cmat[10,10] = -(m^2)*(t^2)*(4+2*m*t)/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 

   # row 11 
   cmat[11,1] = 1/256 
   cmat[11,2] = -1/((256)*(1+m*t)) 
   cmat[11,3] = -2/((256)*(1+m*t)) 
   cmat[11,4] = 4/((256)*(1+m*t)*(2+m*t)) 
   cmat[11,5] = -3/((256)*(1+m*t)) 
   cmat[11,6] = 4/((256)*(1+m*t)*(2+m*t)) 
   cmat[11,7] = 1/((256)*(1+m*t)^2) 
   cmat[11,8] = 8/((256)*(1+m*t)*(2+m*t)) 
   cmat[11,9] = -16/((256)*(1+m*t)*(2+m*t)^2) 
   cmat[11,10] = 2*(m^3)*(t^3)/((256)*((1+m*t)^2)*((2+m*t)^2)*(3+m*t)) 


   #get the beta vector 
   beta = matrix(0,ncol=1,nrow=10) 
   beta[1,1]=1 
   beta[2,1]=exp(-2*m*t1) 
   beta[3,1]=exp(-2*m*t2) 
   beta[4,1]=exp(-m*t1)*exp(-2*m*t2) 
   beta[5,1]=exp(-2*m*t3) 
   beta[6,1]=exp(-m*t1)*exp(-2*m*t3) 
   beta[7,1]=exp(-2*m*t1)*exp(-2*m*t3) 
   beta[8,1]=exp(-m*t2)*exp(-2*m*t3) 
   beta[9,1]=exp(-m*t1)*exp(-m*t2)*exp(-2*m*t3) 
   beta[10,1]=exp((2/t)*(t1-t2))*exp(-2*m*(t2+t3)) 

   weights=matrix(0,ncol=11,nrow=1) 
   w1=weights[1,1]=4 
   w2=weights[1,2]=24 
   w3=weights[1,3]=12 
   w4=weights[1,4]=12 
   w5=weights[1,5]=12 
   w6=weights[1,6]=24 
   w7=weights[1,7]=24 
   w8=weights[1,8]=24 
   w9=weights[1,9]=48 
   w10=weights[1,10]=48 
   w11=weights[1,11]=24 


   p=cmat%*%beta 
   #print(weights%*%p) 

   return(p) 
 } 

 SimDataAsymm = function(myt1,myt2,myt3,theta,mu,samplesize) { 

 	w1=4 
 	w2=24 
 	w3=12 
 	w4=12 
 	w5=12 
 	w6=24 
 	w7=24 
 	w8=24 
 	w9=48 
 	w10=48 
 	w11=24 

   myprobs = GetTrueProbsAsymm(myt1,myt2,myt3,theta,mu) 
   simdata = rmultinom(1,samplesize,c(w1*myprobs[1],w2*myprobs[2],w3*myprobs[3],w4*myprobs[4],w5*myprobs[5],w6*myprobs[6],w7*myprobs[7],w8*myprobs[8],w9*myprobs[9],w10*myprobs[10],w11*myprobs[11])) 

 	return(simdata) 

 } 

 GetVarTheoryAsymm = function(probs,mytheta,mymu,n) { 

   # Note: the site patterns are re-ordered here as follows: 
   # xxxx - 1 
   # xxxy = xxyx - 2 
   # xyxx - 3 
   # yxxx - 4 
   # xyxy = yxxy - 5 ( = 6 in GetTrueProbs Asymm) 
   # xxyy - 6  ( = 5 in GetTrueProbsAsymm) 
   # xxyz - 7 
   # yzxx - 8 
   # xyxz = xyzx - 9 
   # yxxz  = yxzx- 10 
   # xyzw - 11 

   mu = mytheta*mymu 
   theta = 2.0 

 	p1 = 4*probs[1] 
 	p2 = 24*probs[2] 
 	p3 = 12*probs[3] 
 	p4 = 12*probs[4] 
 	p5 = 24*probs[6] 
 	p6 = 12*probs[5] 
 	p7 = 24*probs[7] 
 	p8 = 24*probs[8] 
 	p9 = 48*probs[9] 
 	p10 = 48*probs[10] 
 	p11 = 24*probs[11] 

 	pp1 = probs[1] 
 	pp2 = probs[2] 
 	pp3 = probs[3] 
 	pp4 = probs[4] 
 	pp5 = probs[6] 
 	pp6 = probs[5] 
 	pp7 = probs[7] 
 	pp8 = probs[8] 
 	pp9 = probs[9] 
 	pp10 = probs[10] 
 	pp11 = probs[11] 

 	x12 = (4.0/3.0)*(1+mu*theta)*(3*pp1-7*pp2+8*pp6-8*pp7+10*pp3-5*pp5-10*pp9-6*pp11+9*pp4-12*pp10+18*pp8) 
  x22 = (4.0/3.0)*(1+mu*theta)*(3*pp1+5*pp2-4*pp6-8*pp7-2*pp3+7*pp5-10*pp9-6*pp11+9*pp4+12*pp10-6*pp8) 
  x32 = (4.0/3.0)*(1+mu*theta)*(3*pp1+10*pp2+pp6+2*pp7+5*pp3+2*pp5+4*pp9-6*pp11-3*pp4-12*pp10-6*pp8) 

 	tau1 = -log(x12^(1/(2*mu))) 
 	tau2 = -log(x22^(1/(2*mu))) 
 	tau3 = -log(x32^(1/(2*mu)))  

 	w1=4 
 	w2=24 
 	w3=12 
 	w4=12 
 	w5=12 
 	w6=24 
 	w7=24 
 	w8=24 
 	w9=48 
 	w10=48 
 	w11=24 

 	var1 = p1*(1-p1)/(n*w1^2) 
 	var2 = p2*(1-p2)/(n*w2^2) 
 	var3 = p3*(1-p3)/(n*w3^2) 
 	var4 = p4*(1-p4)/(n*w4^2) 
 	var5 = p5*(1-p5)/(n*w5^2) 
 	var6 = p6*(1-p6)/(n*w6^2) 
 	var7 = p7*(1-p7)/(n*w7^2) 
 	var8 = p8*(1-p8)/(n*w8^2) 
 	var9 = p9*(1-p9)/(n*w9^2) 
 	var10 = p10*(1-p10)/(n*w10^2) 
 	var11 = p11*(1-p11)/(n*w11^2) 

 	covar12 = -p1*p2/(n*w1*w2) 
 	covar13 = -p1*p3/(n*w1*w3) 
 	covar14 = -p1*p4/(n*w1*w4) 
 	covar15 = -p1*p5/(n*w1*w5) 
 	covar16 = -p1*p6/(n*w1*w6) 
 	covar17 = -p1*p7/(n*w1*w7) 
 	covar18 = -p1*p8/(n*w1*w8) 
 	covar19 = -p1*p9/(n*w1*w9) 
 	covar110 = -p1*p10/(n*w1*w10) 
   covar111 = -p1*p11/(n*w1*w11) 

 	covar23 = -p2*p3/(n*w2*w3) 
 	covar24 = -p2*p4/(n*w2*w4) 
 	covar25 = -p2*p5/(n*w2*w5) 
 	covar26 = -p2*p6/(n*w2*w6) 
 	covar27 = -p2*p7/(n*w2*w7) 
 	covar28 = -p2*p8/(n*w2*w8) 
 	covar29 = -p2*p9/(n*w2*w9) 
 	covar210 = -p2*p10/(n*w2*w10) 
 	covar211 = -p2*p11/(n*w2*w11) 

 	covar34 = -p3*p4/(n*w3*w4) 
 	covar35 = -p3*p5/(n*w3*w5) 
 	covar36 = -p3*p6/(n*w3*w6) 
 	covar37 = -p3*p7/(n*w3*w7) 
 	covar38 = -p3*p8/(n*w3*w8) 
 	covar39 = -p3*p9/(n*w3*w9) 
 	covar310 = -p3*p10/(n*w3*w10) 
 	covar311 = -p3*p11/(n*w3*w11) 

 	covar45 = -p4*p5/(n*w4*w5) 
 	covar46 = -p4*p6/(n*w4*w6) 
 	covar47 = -p4*p7/(n*w4*w7) 
 	covar48 = -p4*p8/(n*w4*w8) 
 	covar49 = -p4*p9/(n*w4*w9) 
 	covar410 = -p4*p10/(n*w4*w10) 
 	covar411 = -p4*p11/(n*w4*w11) 

 	covar56 = -p5*p6/(n*w5*w6) 
 	covar57 = -p5*p7/(n*w5*w7) 
 	covar58 = -p5*p8/(n*w5*w8) 
 	covar59 = -p5*p9/(n*w5*w9) 
 	covar510 = -p5*p10/(n*w5*w10) 
 	covar511 = -p5*p11/(n*w5*w11) 

 	covar67 = -p6*p7/(n*w6*w7) 
 	covar68 = -p6*p8/(n*w6*w8) 
 	covar69 = -p6*p9/(n*w6*w9) 
 	covar610 = -p6*p10/(n*w6*w10) 
 	covar611 = -p6*p11/(n*w6*w11) 

 	covar78 = -p7*p8/(n*w7*w8) 
 	covar79 = -p7*p9/(n*w7*w9) 
 	covar710 = -p7*p10/(n*w7*w10) 
 	covar711 = -p7*p11/(n*w7*w11) 

 	covar89 = -p8*p9/(n*w8*w9) 
   covar810 = -p8*p10/(n*w8*w10) 
   covar811 = -p8*p11/(n*w8*w11) 

   covar910 = -p9*p10/(n*w9*w10) 
   covar911 = -p9*p11/(n*w9*w11) 

   covar1011 = -p10*p11/(n*w10*w11) 

 	var_myx1 = (16/9)*((1+mu*theta)^2)*(9*var1+49*var2+64*var6+64*var7+100*var3+25*var5+100*var9+36*var11+81*var4+144*var10+324*var8 
 	                                    -42*covar12+48*covar16-48*covar17+60*covar13-30*covar15-60*covar19-36*covar111+54*covar14-72*covar110+108*covar18 
 	                                               -112*covar26+112*covar27-140*covar23+70*covar25+140*covar29+84*covar211-126*covar24+168*covar210-252*covar28 
 	                                                          -128*covar67+160*covar36-80*covar56-160*covar69-96*covar611+144*covar46-192*covar610+288*covar68  
 	                                                                     -160*covar37+80*covar57+160*covar79+96*covar711-144*covar47+192*covar710-288*covar78 
 	                                                                                -100*covar35-200*covar39-120*covar311+180*covar34-240*covar310+360*covar38 
 	                                                                                            +100*covar59+60*covar511-90*covar45+120*covar510-180*covar58 
 	                                                                                                       +120*covar911-180*covar49+240*covar910-360*covar89 
 	                                                                                                                    -108*covar411+144*covar1011-216*covar811 
 	                                                                                                                                -216*covar410+324*covar48 
 	                                                                                                                                              -432*covar810) 

 	 var_myx2 = (16/9)*((1+mu*theta)^2)*(9*var1+25*var2+16*var6+64*var7+4*var3+49*var5+100*var9+36*var11+81*var4+144*var10+36*var8 
 	                                    +30*covar12-24*covar16-48*covar17-12*covar13+42*covar15-60*covar19-36*covar111+54*covar14+72*covar110-36*covar18  
 	                                               -40*covar26-80*covar27-20*covar23+70*covar25-100*covar29-60*covar211+90*covar24+120*covar210-60*covar28 
 	                                                          +64*covar67+16*covar36-56*covar56+80*covar69+48*covar611-72*covar46-96*covar610+48*covar68 
 	                                                                      +32*covar37-112*covar57+160*covar79+96*covar711-144*covar47-192*covar710+96*covar78 
 	                                                                                  -28*covar35+40*covar39+24*covar311-36*covar34-48*covar310+24*covar38 
 	                                                                                            -140*covar59-84*covar511+126*covar45+168*covar510-84*covar58 
 	                                                                                                       +120*covar911-180*covar49-240*covar910+120*covar89 
 	                                                                                                                   -108*covar411-144*covar1011+72*covar811 
 	                                                                                                                                +216*covar410-108*covar48 
 	                                                                                                                                              -144*covar810) 


 	var_myx3 = (16/9)*((1+mu*theta)^2)*(9*var1+100*var2+var6+4*var7+25*var3+4*var5+16*var9+36*var11+9*var4+144*var10+36*var8 
 	                                    +60*covar12+6*covar16+12*covar17+30*covar13+12*covar15+24*covar19-36*covar111-18*covar14-72*covar110-36*covar18 
 	                                              +20*covar26+40*covar27+100*covar23+40*covar25+80*covar29-120*covar211-60*covar24-240*covar210-120*covar28 
 	                                                          +4*covar67+10*covar36+4*covar56+8*covar69-12*covar611-6*covar46-24*covar610-12*covar68 
 	                                                                    +20*covar37+8*covar57+16*covar79-24*covar711-12*covar47-48*covar710-24*covar78 
 	                                                                                +20*covar35+40*covar39-60*covar311-30*covar34-120*covar310-60*covar38 
 	                                                                                           +16*covar59-24*covar511-12*covar45-48*covar510-24*covar58 
 	                                                                                                      -48*covar911-24*covar49-96*covar910-48*covar89 
 	                                                                                                                  +36*covar411+144*covar1011+72*covar811 
 	                                                                                                                              +72*covar410+36*covar48 
 	                                                                                                                                           +144*covar810) 


 	return(c(x12,x22,x32,tau1,tau2,tau3,var_myx1,var_myx2,var_myx3)) 

 } 

 GetEstimatesAsymm = function(data1,mytheta,mymu,n) { 

   mu = mytheta*mymu 
   theta = 2.0 

   p1 = data1[1]/n 
   p2 = data1[2]/n 
   p3 = data1[3]/n 
   p4 = data1[4]/n 
   p5 = data1[6]/n 
   p6 = data1[5]/n 
   p7 = data1[7]/n 
   p8 = data1[8]/n 
   p9 = data1[9]/n 
   p10 = data1[10]/n 
   p11 = data1[11]/n 

   pp1 = p1/4  
   pp2 = p2/24 
   pp3 = p3/12 
   pp4 = p4/12 
   pp5 = p5/24 
   pp6 = p6/12 
   pp7 = p7/24 
   pp8 = p8/24 
   pp9 = p9/48 
   pp10 = p10/48 
   pp11 = p11/24  

   x12 = (4.0/3.0)*(1+mu*theta)*(3*pp1-7*pp2+8*pp6-8*pp7+10*pp3-5*pp5-10*pp9-6*pp11+9*pp4-12*pp10+18*pp8) 
   x22 = (4.0/3.0)*(1+mu*theta)*(3*pp1+5*pp2-4*pp6-8*pp7-2*pp3+7*pp5-10*pp9-6*pp11+9*pp4+12*pp10-6*pp8) 
   x32 = (4.0/3.0)*(1+mu*theta)*(3*pp1+10*pp2+pp6+2*pp7+5*pp3+2*pp5+4*pp9-6*pp11-3*pp4-12*pp10-6*pp8) 

   tau1 = -log(x12^(1/(2*mu))) 
   tau2 = -log(x22^(1/(2*mu))) 
   tau3 = -log(x32^(1/(2*mu)))  

   w1=4 
 	w2=24 
 	w3=12 
 	w4=12 
 	w5=12 
 	w6=24 
 	w7=24 
 	w8=24 
 	w9=48 
 	w10=48 
 	w11=24 

   var1 = p1*(1-p1)/(n*w1^2) 
   var2 = p2*(1-p2)/(n*w2^2) 
   var3 = p3*(1-p3)/(n*w3^2) 
   var4 = p4*(1-p4)/(n*w4^2) 
   var5 = p5*(1-p5)/(n*w5^2) 
   var6 = p6*(1-p6)/(n*w6^2) 
   var7 = p7*(1-p7)/(n*w7^2) 
   var8 = p8*(1-p8)/(n*w8^2) 
   var9 = p9*(1-p9)/(n*w9^2) 
   var10 = p10*(1-p10)/(n*w10^2) 
 	var11 = p11*(1-p11)/(n*w11^2) 

 	covar12 = -p1*p2/(n*w1*w2) 
 	covar13 = -p1*p3/(n*w1*w3) 
 	covar14 = -p1*p4/(n*w1*w4) 
 	covar15 = -p1*p5/(n*w1*w5) 
 	covar16 = -p1*p6/(n*w1*w6) 
 	covar17 = -p1*p7/(n*w1*w7) 
 	covar18 = -p1*p8/(n*w1*w8) 
 	covar19 = -p1*p9/(n*w1*w9) 
 	covar110 = -p1*p10/(n*w1*w10) 
   covar111 = -p1*p11/(n*w1*w11) 

 	covar23 = -p2*p3/(n*w2*w3) 
 	covar24 = -p2*p4/(n*w2*w4) 
 	covar25 = -p2*p5/(n*w2*w5) 
 	covar26 = -p2*p6/(n*w2*w6) 
 	covar27 = -p2*p7/(n*w2*w7) 
 	covar28 = -p2*p8/(n*w2*w8) 
 	covar29 = -p2*p9/(n*w2*w9) 
 	covar210 = -p2*p10/(n*w2*w10) 
 	covar211 = -p2*p11/(n*w2*w11) 

 	covar34 = -p3*p4/(n*w3*w4) 
 	covar35 = -p3*p5/(n*w3*w5) 
 	covar36 = -p3*p6/(n*w3*w6) 
 	covar37 = -p3*p7/(n*w3*w7) 
 	covar38 = -p3*p8/(n*w3*w8) 
 	covar39 = -p3*p9/(n*w3*w9) 
 	covar310 = -p3*p10/(n*w3*w10) 
 	covar311 = -p3*p11/(n*w3*w11) 

 	covar45 = -p4*p5/(n*w4*w5) 
 	covar46 = -p4*p6/(n*w4*w6) 
 	covar47 = -p4*p7/(n*w4*w7) 
 	covar48 = -p4*p8/(n*w4*w8) 
 	covar49 = -p4*p9/(n*w4*w9) 
 	covar410 = -p4*p10/(n*w4*w10) 
 	covar411 = -p4*p11/(n*w4*w11) 

 	covar56 = -p5*p6/(n*w5*w6) 
 	covar57 = -p5*p7/(n*w5*w7) 
 	covar58 = -p5*p8/(n*w5*w8) 
 	covar59 = -p5*p9/(n*w5*w9) 
 	covar510 = -p5*p10/(n*w5*w10) 
 	covar511 = -p5*p11/(n*w5*w11) 

 	covar67 = -p6*p7/(n*w6*w7) 
 	covar68 = -p6*p8/(n*w6*w8) 
 	covar69 = -p6*p9/(n*w6*w9) 
 	covar610 = -p6*p10/(n*w6*w10) 
 	covar611 = -p6*p11/(n*w6*w11) 

 	covar78 = -p7*p8/(n*w7*w8) 
 	covar79 = -p7*p9/(n*w7*w9) 
 	covar710 = -p7*p10/(n*w7*w10) 
 	covar711 = -p7*p11/(n*w7*w11) 

 	covar89 = -p8*p9/(n*w8*w9) 
   covar810 = -p8*p10/(n*w8*w10) 
   covar811 = -p8*p11/(n*w8*w11) 

   covar910 = -p9*p10/(n*w9*w10) 
   covar911 = -p9*p11/(n*w9*w11) 

   covar1011 = -p10*p11/(n*w10*w11) 

 	var_myx1 = (16/9)*((1+mu*theta)^2)*(9*var1+49*var2+64*var6+64*var7+100*var3+25*var5+100*var9+36*var11+81*var4+144*var10+324*var8 
 	                                    -42*covar12+48*covar16-48*covar17+60*covar13-30*covar15-60*covar19-36*covar111+54*covar14-72*covar110+108*covar18 
 	                                               -112*covar26+112*covar27-140*covar23+70*covar25+140*covar29+84*covar211-126*covar24+168*covar210-252*covar28 
 	                                                          -128*covar67+160*covar36-80*covar56-160*covar69-96*covar611+144*covar46-192*covar610+288*covar68  
 	                                                                     -160*covar37+80*covar57+160*covar79+96*covar711-144*covar47+192*covar710-288*covar78 
 	                                                                                -100*covar35-200*covar39-120*covar311+180*covar34-240*covar310+360*covar38 
 	                                                                                            +100*covar59+60*covar511-90*covar45+120*covar510-180*covar58 
 	                                                                                                       +120*covar911-180*covar49+240*covar910-360*covar89 
 	                                                                                                                    -108*covar411+144*covar1011-216*covar811 
 	                                                                                                                                -216*covar410+324*covar48 
 	                                                                                                                                              -432*covar810) 


  var_myx2 = (16/9)*((1+mu*theta)^2)*(9*var1+25*var2+16*var6+64*var7+4*var3+49*var5+100*var9+36*var11+81*var4+144*var10+36*var8 
 	                                    +30*covar12-24*covar16-48*covar17-12*covar13+42*covar15-60*covar19-36*covar111+54*covar14+72*covar110-36*covar18  
 	                                               -40*covar26-80*covar27-20*covar23+70*covar25-100*covar29-60*covar211+90*covar24+120*covar210-60*covar28 
 	                                                          +64*covar67+16*covar36-56*covar56+80*covar69+48*covar611-72*covar46-96*covar610+48*covar68 
 	                                                                      +32*covar37-112*covar57+160*covar79+96*covar711-144*covar47-192*covar710+96*covar78 
 	                                                                                  -28*covar35+40*covar39+24*covar311-36*covar34-48*covar310+24*covar38 
 	                                                                                            -140*covar59-84*covar511+126*covar45+168*covar510-84*covar58 
 	                                                                                                       +120*covar911-180*covar49-240*covar910+120*covar89 
 	                                                                                                                   -108*covar411-144*covar1011+72*covar811 
 	                                                                                                                                +216*covar410-108*covar48 
 	                                                                                                                                              -144*covar810) 

 	var_myx3 = (16/9)*((1+mu*theta)^2)*(9*var1+100*var2+var6+4*var7+25*var3+4*var5+16*var9+36*var11+9*var4+144*var10+36*var8 
 	                                    +60*covar12+6*covar16+12*covar17+30*covar13+12*covar15+24*covar19-36*covar111-18*covar14-72*covar110-36*covar18 
 	                                              +20*covar26+40*covar27+100*covar23+40*covar25+80*covar29-120*covar211-60*covar24-240*covar210-120*covar28 
 	                                                          +4*covar67+10*covar36+4*covar56+8*covar69-12*covar611-6*covar46-24*covar610-12*covar68 
 	                                                                    +20*covar37+8*covar57+16*covar79-24*covar711-12*covar47-48*covar710-24*covar78 
 	                                                                                +20*covar35+40*covar39-60*covar311-30*covar34-120*covar310-60*covar38 
 	                                                                                           +16*covar59-24*covar511-12*covar45-48*covar510-24*covar58 
 	                                                                                                      -48*covar911-24*covar49-96*covar910-48*covar89 
 	                                                                                                                  +36*covar411+144*covar1011+72*covar811 
 	                                                                                                                              +72*covar410+36*covar48 
 	                                                                                                                                           +144*covar810) 


  return(c(x12,x22,x32,tau1,tau2,tau3,var_myx1,var_myx2,var_myx3)) 

 } 

 RunSimAsymm = function(settau1,settau2,settau3,settheta,setmu,setn,nsimreps) { 

   myn = nsimreps-1
   q = SimDataAsymm(myt1=settau1,myt2=settau2,myt3=settau3,theta=settheta,mu=setmu,samplesize=setn) 
   results = GetEstimatesAsymm(q,settheta,setmu,setn) 

   for (i in 1:myn) { 

     q = SimDataAsymm(myt1=settau1,myt2=settau2,myt3=settau3,theta=settheta,mu=setmu,samplesize=setn) 
     ests = GetEstimatesAsymm(q,settheta,setmu,setn) 
     results=rbind(results,ests)   

   } 

   return(results) 

 } 

``` 


 
<br><br> 
Setting 1: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.001$, $n=100,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 1:

nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.001
smu=4.0/3.0

results1a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq1a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals1a = GetVarTheoryAsymm(probs=trueq1a,stheta,smu,nsites)
MakeSummaries(results1a,truevals1a,stheta,smu,nreps)
```


<br><br> 
Setting 2: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.005$, $n=100,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 2:

nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.005
smu=4.0/3.0

results2a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq2a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals2a = GetVarTheoryAsymm(probs=trueq2a,stheta,smu,nsites)
MakeSummaries(results2a,truevals2a,stheta,smu,nreps)
```


<br><br> 
Setting 3: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.001$, $n=100,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 3:

nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.001
smu=4.0/3.0

results3a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq3a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals3a = GetVarTheoryAsymm(probs=trueq3a,stheta,smu,nsites)
MakeSummaries(results3a,truevals3a,stheta,smu,nreps)
```

<br><br> 
Setting 4: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.005$, $n=100,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 4:

nsites = 100000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.005
smu=4.0/3.0

results4a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq4a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals4a = GetVarTheoryAsymm(probs=trueq4a,stheta,smu,nsites)
MakeSummaries(results4a,truevals4a,stheta,smu,nreps)
```



<br><br> 
Setting 5: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.001$, $n=10,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 5:

nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.001
smu=4.0/3.0

results5a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq5a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals5a = GetVarTheoryAsymm(probs=trueq5a,stheta,smu,nsites)
MakeSummaries(results5a,truevals5a,stheta,smu,nreps)
```


<br><br> 
Setting 6: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.5$, $\theta = 0.005$, $n=10,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 6:

nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.5
stheta = 0.005
smu=4.0/3.0

results6a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq6a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals6a = GetVarTheoryAsymm(probs=trueq6a,stheta,smu,nsites)
MakeSummaries(results6a,truevals6a,stheta,smu,nreps)
```


<br><br> 
Setting 7: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.001$, $n=10,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 7:

nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.001
smu=4.0/3.0

results7a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq7a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals7a = GetVarTheoryAsymm(probs=trueq7a,stheta,smu,nsites)
MakeSummaries(results7a,truevals7a,stheta,smu,nreps)
```

<br><br> 
Setting 8: $\tau_1 = 1.0$, $\tau_2 = 1.5$, $\tau_3 = 2.0$, $\theta = 0.005$, $n=10,000$  

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 8:

nsites = 10000
nreps=25000
stau1 = 1.0
stau2 = 1.5
stau3 = 2.0
stheta = 0.005
smu=4.0/3.0

results8a = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
trueq8a = GetTrueProbsAsymm(stau1,stau2,stau3,stheta,smu)
truevals8a = GetVarTheoryAsymm(probs=trueq8a,stheta,smu,nsites)
MakeSummaries(results8a,truevals8a,stheta,smu,nreps)
```

<br><br><br>

#### Part III: Hypothesis testing for species delimitation ####

We now consider testing for $\tau_1=0$ in a species delimitation context. We note that this corresponds to testing $x_1 = 1$.  Since the $x-scale$ is more natural here, we use the test statistic 
\begin{equation}
Z = \frac{\hat{x_1} - 1}{\sqrt{\hat{var}(\hat{x})}}
\end{equation}

We consider only the case for Setting 1 for the symmetric tree -- the other cases are analogous. To examine the power of the test, we consider $\tau_1 \in (0,1.0)$ and examine the portion of tests that reject $H_0$ for values of $\tau_1$ in this interval.

```{r, fig.width=10, fig.height=4, echo=FALSE}
#Setting 1 - Symmetric, theta = 0.001:

nsites = 100000
nreps=1000
stau2 = 1.5
stau3 = 2.5
stheta = 0.001
smu=4.0/3.0

teststats = matrix(0,nrow=1000,ncol=16)
stau1values = c(0.025,0.05,0.075,0.1,0.125,0.15,0.175,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0)
j = 1
for (stau1 in stau1values) {
  results1 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
  for (i in 1:1000) {
    teststats[i,j] = (results1[i,1]-1)/sqrt(results1[i,7])
  }
  j = j+1
}  
  
powersymm = matrix(0,ncol=1,nrow=16)
for (j in 1:16) powersymm[j,1] = sum(abs(teststats[,j])>1.96)/nreps

# Plot histograms of the test statistics for specific choices of tau1
par(mfrow=c(1,3),mai=c(1,1,0.25,0.25))
hist(teststats[,1],col="lightskyblue",xlab="Test statistics, Z",main=expression(paste(tau[1],"=0")),cex.lab=1.7,cex.axis=1.4,cex.main=2.0)
hist(teststats[,4],col="lightskyblue",xlab="Test statistics, Z",main=expression(paste(tau[1],"=0.1")),cex.lab=1.7,cex.axis=1.4,cex.main=2.0)
hist(teststats[,16],col="lightskyblue",xlab="Test statistics, Z",main=expression(paste(tau[1],"=1.0")),cex.lab=1.7,cex.axis=1.4,cex.main=2.0)


# repeat for theta = 0.005

stheta = 0.005
teststats = matrix(0,nrow=1000,ncol=16)
stau1values = c(0.025,0.05,0.075,0.1,0.125,0.15,0.175,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0)
j = 1
for (stau1 in stau1values) {
  results1 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
  for (i in 1:1000) {
    teststats[i,j] = (results1[i,1]-1)/sqrt(results1[i,7])
  }
  j = j+1
}  
  
powersymm2 = matrix(0,ncol=1,nrow=16)
for (j in 1:16) powersymm2[j,1] = sum(abs(teststats[,j])>1.96)/nreps



#Setting 1 - Asymmetric, theta = 0.001:

nsites = 100000
nreps=1000
stau2 = 1.5
stau3 = 2.5
stheta = 0.001
smu=4.0/3.0

teststats = matrix(0,nrow=1000,ncol=16)
stau1values = c(0.025,0.05,0.075,0.1,0.125,0.15,0.175,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0)
j = 1
for (stau1 in stau1values) {
  results1 = RunSimAsymm(stau1,stau2,stau3,stheta,smu,nsites,nreps)
  for (i in 1:1000) {
    teststats[i,j] = (results1[i,1]-1)/sqrt(results1[i,7])
  }
  j = j+1
}  
  
powerasymm = matrix(0,ncol=1,nrow=16)
for (j in 1:16) powerasymm[j,1] = sum(abs(teststats[,j])>1.96)/nreps

# repeat for theta = 0.005

stheta = 0.005
teststats = matrix(0,nrow=1000,ncol=16)
stau1values = c(0.025,0.05,0.075,0.1,0.125,0.15,0.175,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0)
j = 1
for (stau1 in stau1values) {
  results1 = RunSim(stau1,stau2,stau3,stheta,smu,nsites,nreps)
  for (i in 1:1000) {
    teststats[i,j] = (results1[i,1]-1)/sqrt(results1[i,7])
  }
  j = j+1
}  
  
powerasymm2 = matrix(0,ncol=1,nrow=16)
for (j in 1:16) powerasymm2[j,1] = sum(abs(teststats[,j])>1.96)/nreps



par(mfrow=c(1,1),par(mai=c(1,1,0.25,0.25)))
plot(stau1values,powersymm[,1],type='l',lwd=3,col="lightskyblue",xlab=expression(paste(tau[1])),ylab="Power",cex.lab=1.7,cex.axis=1.4)
lines(stau1values,powersymm2[,1],col="lightskyblue",lwd=3,lty=2)
lines(stau1values,powerasymm[,1],col="maroon",lwd=3)
lines(stau1values,powerasymm2[,1],col="maroon",lwd=3,lty=2)
legend(0.6,0.6,legend=c(expression(paste("Symmetric Tree, ",theta,"=0.001")),expression(paste("Symmetric Tree, ",theta,"=0.005")),expression(paste("Asymmetric Tree, ",theta,"=0.001")),expression(paste("Asymmetric Tree, ",theta,"=0.005"))),lty=c(1,2,1,2),col=c("lightskyblue","lightskyblue","maroon","maroon"),lwd=c(3,3,3,3),cex=1.1)

```
